<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Notice Translator</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#0b0f17; color:#e9eef7; }
    .wrap { max-width: 980px; margin:0 auto; padding: 20px; }
    .card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 14px;
      margin: 12px 0;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      position: relative;
      z-index: 1;
    }
    h1 { font-size: 20px; margin: 0 0 10px; }
    h2 { font-size: 16px; margin: 0 0 10px; opacity: 0.95; }
    label { display:block; font-size:12px; opacity:0.85; margin:10px 0 6px; }
    input, textarea, select, button {
      width:100%;
      box-sizing:border-box;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.25);
      color:#e9eef7;
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    textarea { min-height: 140px; resize: vertical; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .muted { font-size: 12px; opacity: 0.75; line-height: 1.4; }
    .btnRow { display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    .btnRow button { width:auto; min-width: 180px; cursor:pointer; }
    button#runBtn {
      background: linear-gradient(135deg, rgba(112,233,255,0.25), rgba(255,112,200,0.22));
      border: 1px solid rgba(255,255,255,0.22);
      font-weight: 800;
      position: relative;
      z-index: 9999;
      pointer-events: auto;
    }
    button:disabled { opacity: 0.55; cursor: not-allowed; }

    /* 디버그 */
    .debugHidden { display:none; }
    pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      padding: 10px;
      margin: 10px 0 0;
      font-size: 12px;
      line-height: 1.35;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Notice Translator</h1>
      <div class="muted">
        입력 UI 없이 바로 동작합니다. (Worker는 Origin 제한 방식)
        <br/>디버그 로그는 <code>?debug=1</code>일 때만 표시됩니다.
      </div>
    </div>

    <div class="card">
      <h2>공지 입력</h2>
      <label>현상 입력(한국어 원문)</label>
      <textarea id="srcText" placeholder="예) 접속 불가 현상"></textarea>

      <div class="row" style="margin-top:8px;">
        <div>
          <label>대상 언어</label>
          <select id="lang">
            <option value="EN">EN</option>
            <option value="JA">JA</option>
          </select>
        </div>
        <div>
          <label>요청 포맷</label>
          <select id="payloadMode">
            <option value="simple">simple: { text, targetLang }</option>
            <option value="openai">openai-ish: { input, target }</option>
          </select>
        </div>
      </div>

      <div class="btnRow">
        <button id="runBtn" type="button">번역/생성</button>
        <button id="clickTestBtn" type="button">클릭 테스트</button>
      </div>
    </div>

    <div class="card">
      <h2>결과</h2>
      <label>Translated Text</label>
      <textarea id="outText" readonly placeholder="여기에 결과가 표시됩니다."></textarea>
    </div>

    <div class="card" id="debugCard">
      <h2>디버그</h2>
      <div class="btnRow">
        <button id="diagBtn" type="button">elementFromPoint 재검사</button>
        <button id="logClearBtn" type="button">로그 지우기</button>
      </div>
      <pre id="diagBox">Loading...</pre>
      <pre id="logBox">(no logs)</pre>
    </div>
  </div>

<script>
(() => {
  // ✅ 여기를 고정: 입력 UI 없음
  const ENDPOINT = "https://broad-shadow-26ac.kkwak2kg.workers.dev/translate";

  const $ = (sel) => document.querySelector(sel);
  const now = () => new Date().toISOString();

  const debugEnabled = new URLSearchParams(location.search).get("debug") === "1";
  const debugCard = $("#debugCard");
  if (!debugEnabled) debugCard.classList.add("debugHidden");

  const diagBox = $("#diagBox");
  const logBox = $("#logBox");

  function appendLog(obj) {
    if (!debugEnabled) return;
    const prev = logBox.textContent === "(no logs)" ? "" : logBox.textContent + "\n\n";
    logBox.textContent = prev + JSON.stringify(obj, null, 2);
  }

  function elementFromPointReport() {
    const b = $("#runBtn");
    const r = b.getBoundingClientRect();
    const x = r.left + r.width/2, y = r.top + r.height/2;
    const topEl = document.elementFromPoint(x, y);
    return {
      point: { x, y },
      topTag: topEl?.tagName ?? null,
      topId: topEl?.id ?? null,
      topClass: topEl?.className ?? null,
      isTopRunBtn: topEl === b,
      topPointerEvents: topEl ? getComputedStyle(topEl).pointerEvents : null,
      runBtnPointerEvents: getComputedStyle(b).pointerEvents,
      runBtnZ: getComputedStyle(b).zIndex,
      typeof__VSAFE_LOADED__: typeof window.__VSAFE_LOADED__,
    };
  }

  function refreshDiagnostics() {
    if (!debugEnabled) return;
    diagBox.textContent = JSON.stringify(elementFromPointReport(), null, 2);
  }

  function buildBody() {
    const text = $("#srcText").value ?? "";
    const targetLang = $("#lang").value;
    const mode = $("#payloadMode").value;

    if (mode === "openai") return { input: text, target: targetLang };
    return { text, targetLang };
  }

  async function runTranslate() {
    const body = buildBody();

    appendLog({ t: now(), type: "runBtn_clicked", endpoint: ENDPOINT, bodyPreview: body });

    $("#runBtn").disabled = true;
    $("#runBtn").textContent = "요청 중...";

    try {
      const res = await fetch(ENDPOINT, {
        method: "POST",
        mode: "cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      const text = await res.text();
      let parsed = null;
      try { parsed = JSON.parse(text); } catch (_) {}

      appendLog({
        t: now(),
        type: "response",
        status: res.status,
        ok: res.ok,
        respHeaders: {
          "content-type": res.headers.get("content-type"),
          "www-authenticate": res.headers.get("www-authenticate"),
        },
        bodyText: text,
      });

      if (!res.ok) {
        $("#outText").value =
          `HTTP ${res.status}\n\n` +
          (parsed ? JSON.stringify(parsed, null, 2) : text);
        return;
      }

      // 결과 추출(Worker 응답 형태가 다를 수 있어 유연하게)
      if (parsed && typeof parsed === "object") {
        const candidate =
          parsed.translatedText ??
          parsed.translation ??
          parsed.text ??
          parsed.output ??
          parsed.result ??
          null;
        $("#outText").value = (typeof candidate === "string")
          ? candidate
          : JSON.stringify(parsed, null, 2);
      } else {
        $("#outText").value = text;
      }
    } catch (err) {
      appendLog({ t: now(), type: "fetch_error", message: String(err) });
      $("#outText").value = "Fetch error: " + String(err);
    } finally {
      $("#runBtn").disabled = false;
      $("#runBtn").textContent = "번역/생성";
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    window.__VSAFE_LOADED__ = true;

    $("#runBtn").addEventListener("click", () => runTranslate());
    $("#clickTestBtn").addEventListener("click", () => alert("✅ 클릭 이벤트가 정상적으로 버튼에 도달했습니다."));

    if (debugEnabled) {
      refreshDiagnostics();
      $("#diagBtn").addEventListener("click", refreshDiagnostics);
      $("#logClearBtn").addEventListener("click", () => logBox.textContent = "(no logs)");
      window.addEventListener("resize", () => setTimeout(refreshDiagnostics, 0));
      window.addEventListener("scroll", () => setTimeout(refreshDiagnostics, 0), { passive: true });
    }
  });
})();
</script>
</body>
</html>
