<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Professional Notice Master (Safe Token Input)</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a30; --panel2:#0c162b;
      --text:#e6eefc; --muted:#9db1d6; --line:#1f3158;
      --accent:#3dd6ff; --ok:#32d583; --warn:#fdb022; --bad:#f97066;
      --chip:#0a1733;
      --input:#0b1730;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:24px; background:linear-gradient(180deg,#050912 0%,#0b1220 60%);
      color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial;
      display:flex; justify-content:center;
    }
    .wrap{width:min(1100px, 100%);}
    .card{
      background:rgba(15,26,48,.9);
      border:1px solid rgba(31,49,88,.7);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .header{
      padding:22px 22px 16px;
      background:linear-gradient(180deg, rgba(61,214,255,.12), rgba(61,214,255,0));
      border-bottom:1px solid rgba(31,49,88,.6);
    }
    h1{margin:0 0 6px; font-size:22px; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:13px; line-height:1.4}
    .note{
      margin-top:12px;
      padding:12px 14px;
      background:rgba(12,22,43,.9);
      border:1px solid rgba(31,49,88,.7);
      border-radius:14px;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.5;
    }
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
      padding:18px 22px 22px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr;}
    }
    .panel{
      background:rgba(12,22,43,.9);
      border:1px solid rgba(31,49,88,.7);
      border-radius:16px;
      padding:14px;
    }
    .panel h2{
      margin:0 0 10px;
      font-size:14px;
      color:#d7e6ff;
      letter-spacing:.2px;
    }
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
    input, select, textarea{
      width:100%;
      background:rgba(11,23,48,.95);
      border:1px solid rgba(31,49,88,.8);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:90px; resize:vertical;}
    input:focus, select:focus, textarea:focus{border-color:rgba(61,214,255,.9); box-shadow:0 0 0 3px rgba(61,214,255,.12);}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;}
    @media (max-width: 560px){ .row, .row3{grid-template-columns:1fr;} }
    .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      background:rgba(10,23,51,.9);
      border:1px solid rgba(31,49,88,.8);
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .chip input{width:auto; margin:0;}
    .btn{
      width:100%;
      margin-top:12px;
      padding:14px 14px;
      border:0;
      border-radius:14px;
      color:#031018;
      font-weight:800;
      font-size:15px;
      cursor:pointer;
      background:linear-gradient(135deg, rgba(61,214,255,1), rgba(50,213,131,1));
      box-shadow:0 10px 20px rgba(0,0,0,.25);
    }
    .btn:active{transform:translateY(1px);}
    .statusbar{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(31,49,88,.8);
      background:rgba(10,23,51,.9);
      color:var(--muted);
    }
    .pill.ok{border-color:rgba(50,213,131,.6); color:#b8f5d6;}
    .pill.bad{border-color:rgba(249,112,102,.6); color:#ffd1cd;}
    .pill.warn{border-color:rgba(253,176,34,.6); color:#ffe6b0;}
    .outGrid{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 900px){ .outGrid{grid-template-columns:1fr;} }
    .outBox{
      background:rgba(11,18,32,.7);
      border:1px solid rgba(31,49,88,.7);
      border-radius:14px;
      padding:12px;
      min-height:140px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .outTitle{display:flex; justify-content:space-between; align-items:center;}
    .outTitle strong{font-size:13px;}
    .small{font-size:12px; color:var(--muted);}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    pre{
      white-space:pre-wrap;
      word-break:break-word;
      margin:0;
      color:#dbe9ff;
      font-size:13px;
      line-height:1.45;
    }
    .err{
      border-color:rgba(249,112,102,.65) !important;
      background:rgba(249,112,102,.08) !important;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <h1>Professional Notice Master (vSafe)</h1>
        <div class="sub">
          브라우저에 <b>Groq API Key를 저장하지 않는</b> 방식입니다.<br/>
          번역은 Cloudflare Worker의 <code>/translate</code> 엔드포인트로 요청되며, 필요 시 <code>X-Translate-Token</code>을 <b>직접 입력</b>해 사용합니다.
        </div>
        <div class="note">
          ✅ 안전 포인트: GitHub Pages 코드에 토큰을 하드코딩하지 않음(공개 저장소에 올려도 유출 위험 감소).<br/>
          ⚠️ Worker에서 <code>TRANSLATE_TOKEN</code>을 켜 두었다면, 아래 “Translate Token”을 입력해야 401이 사라집니다.
        </div>
      </div>

      <div class="grid">
        <!-- LEFT: Settings + Form -->
        <div class="panel">
          <h2>1) 연결 설정</h2>

          <label>Worker Translate Endpoint (예: https://xxxx.workers.dev/translate)</label>
          <input id="endpoint" placeholder="https://YOUR-WORKER.workers.dev/translate" />

          <label>Translate Token (Worker의 TRANSLATE_TOKEN과 동일 / 없으면 비워도 됨)</label>
          <input id="token" type="password" placeholder="(선택) X-Translate-Token 값" />

          <div class="chips">
            <label class="chip" title="이 PC 브라우저에만 저장됩니다(세션 저장).">
              <input id="remember" type="checkbox" />
              토큰/엔드포인트 세션 저장
            </label>
            <span class="chip mono" id="originChip"></span>
          </div>

          <div class="statusbar">
            <span class="pill" id="pillReady">대기중</span>
            <span class="pill warn" id="pillHint">401이면 토큰/값 불일치</span>
          </div>

          <hr style="border:0;border-top:1px solid rgba(31,49,88,.6); margin:14px 0;"/>

          <h2>2) 공지 입력</h2>

          <div class="row">
            <div>
              <label>유저 호칭</label>
              <input id="salute" value="모험가 여러분" />
            </div>
            <div>
              <label>화자명</label>
              <input id="speaker" value="바바" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>공지 유형</label>
              <select id="category">
                <option>이슈 현상 안내</option>
                <option>점검 안내</option>
                <option>이벤트 안내</option>
                <option>공지</option>
              </select>
            </div>
            <div>
              <label>발생/확인 일시</label>
              <input id="when" type="datetime-local" />
            </div>
          </div>

          <label>현상 입력(한국어 원문)</label>
          <textarea id="bodyKo">접속 불가 현상</textarea>

          <label>언어 선택</label>
          <div class="chips">
            <label class="chip"><input type="checkbox" id="langKO" checked /> KO</label>
            <label class="chip"><input type="checkbox" id="langEN" checked /> EN</label>
            <label class="chip"><input type="checkbox" id="langJA" /> JA</label>
          </div>

          <button class="btn" id="btnRun">번역/생성</button>
          <div class="small" style="margin-top:10px;">
            디버그: 아래 결과 박스에 <span class="mono">HTTP status</span>와 에러 원문이 표시됩니다.
          </div>
        </div>

        <!-- RIGHT: Output -->
        <div class="panel">
          <h2>3) 결과</h2>
          <div class="outGrid">
            <div class="outBox" id="boxKO">
              <div class="outTitle">
                <strong>KO</strong>
                <span class="small mono" id="stKO">-</span>
              </div>
              <pre id="outKO"></pre>
            </div>
            <div class="outBox" id="boxEN">
              <div class="outTitle">
                <strong>EN</strong>
                <span class="small mono" id="stEN">-</span>
              </div>
              <pre id="outEN"></pre>
            </div>
            <div class="outBox" id="boxJA">
              <div class="outTitle">
                <strong>JA</strong>
                <span class="small mono" id="stJA">-</span>
              </div>
              <pre id="outJA"></pre>
            </div>
          </div>

          <hr style="border:0;border-top:1px solid rgba(31,49,88,.6); margin:14px 0;"/>

          <h2>4) 네트워크 로그</h2>
          <div class="outBox" style="min-height:180px;">
            <div class="outTitle">
              <strong>Last Request / Response</strong>
              <span class="small mono" id="stNET">-</span>
            </div>
            <pre class="mono" id="netlog"></pre>
          </div>

          <div class="small" style="margin-top:10px;">
            팁: 401이면 대개 <b>X-Translate-Token 누락/불일치</b>입니다. 403이면 Worker 내부에서 upstream(Groq/Vercel) 거부일 수 있어요.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------- Helpers ----------
  const $ = (id) => document.getElementById(id);
  const nowLocalISO = () => {
    const d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0,16);
  };

  function setPill(text, kind) {
    const pill = $("pillReady");
    pill.textContent = text;
    pill.className = "pill" + (kind ? (" " + kind) : "");
  }

  function setBoxStatus(lang, text, ok=true) {
    const st = $("st" + lang);
    st.textContent = text;
    const box = $("box" + lang);
    box.classList.toggle("err", !ok);
  }

  function writeOut(lang, text) {
    $("out" + lang).textContent = text || "";
  }

  function logNet(obj) {
    $("netlog").textContent = JSON.stringify(obj, null, 2);
    $("stNET").textContent = new Date().toLocaleString();
  }

  function buildPrompt({salute, speaker, category, when, bodyKo, target}) {
    // 필요하면 여기 템플릿을 더 고급화해도 됨
    const whenText = when ? when.replace("T", " ") : "";
    return [
      `너는 게임 공지 번역가다.`,
      `아래 한국어 공지를 ${target}로 자연스럽고 공손하게 번역하라.`,
      `고유명사는 유지하고, 날짜/시간 포맷은 자연스럽게 유지하라.`,
      ``,
      `[공지정보]`,
      `- 유저 호칭: ${salute}`,
      `- 화자명: ${speaker}`,
      `- 공지 유형: ${category}`,
      `- 발생/확인 일시: ${whenText}`,
      ``,
      `[한국어 원문]`,
      `${bodyKo}`.trim()
    ].join("\n");
  }

  async function callWorkerTranslate(endpoint, token, payload) {
    const headers = { "Content-Type": "application/json" };
    if (token && token.trim()) headers["X-Translate-Token"] = token.trim();

    const reqInfo = { endpoint, headers, payload };
    setPill("요청중...", "warn");

    let res, text;
    try {
      res = await fetch(endpoint, { method: "POST", headers, body: JSON.stringify(payload) });
      text = await res.text();
    } catch (e) {
      logNet({ request: reqInfo, networkError: String(e) });
      throw new Error("NETWORK_ERROR: " + e.message);
    }

    // 기록
    logNet({
      request: reqInfo,
      response: {
        status: res.status,
        statusText: res.statusText,
        body: text
      }
    });

    // JSON 파싱 시도
    let json = null;
    try { json = JSON.parse(text); } catch (_) {}

    if (!res.ok) {
      const msg = (json && (json.error?.message || json.error || json.message)) ? (json.error?.message || json.error || json.message) : text;
      const err = new Error(`HTTP_${res.status}: ${msg}`);
      err.status = res.status;
      err.raw = text;
      throw err;
    }

    // 성공 응답이 OpenAI/Groq 형태일 수도 있고, 단순 {text:""}일 수도 있음
    return json || { raw: text };
  }

  function extractTextFromResponse(json) {
    // 1) OpenAI/Groq chat.completions 형태
    const c = json?.choices?.[0]?.message?.content;
    if (typeof c === "string" && c.trim()) return c.trim();
    // 2) 커스텀 형태
    if (typeof json?.text === "string" && json.text.trim()) return json.text.trim();
    if (typeof json?.translation === "string" && json.translation.trim()) return json.translation.trim();
    // 3) fallback
    return JSON.stringify(json, null, 2);
  }

  // ---------- Init ----------
  $("when").value = nowLocalISO();
  $("originChip").textContent = "Origin: " + location.origin;

  // Restore session values (optional)
  try {
    const saved = sessionStorage.getItem("notice_safe_cfg");
    if (saved) {
      const cfg = JSON.parse(saved);
      if (cfg.endpoint) $("endpoint").value = cfg.endpoint;
      if (cfg.token) $("token").value = cfg.token;
      $("remember").checked = true;
    }
  } catch(_) {}

  $("remember").addEventListener("change", () => {
    if (!$("remember").checked) {
      sessionStorage.removeItem("notice_safe_cfg");
    } else {
      sessionStorage.setItem("notice_safe_cfg", JSON.stringify({
        endpoint: $("endpoint").value.trim(),
        token: $("token").value
      }));
    }
  });

  ["endpoint", "token"].forEach(id => {
    $(id).addEventListener("input", () => {
      if ($("remember").checked) {
        sessionStorage.setItem("notice_safe_cfg", JSON.stringify({
          endpoint: $("endpoint").value.trim(),
          token: $("token").value
        }));
      }
    });
  });

  // ---------- Main ----------
  $("btnRun").addEventListener("click", async () => {
    const endpoint = $("endpoint").value.trim();
    const token = $("token").value; // password input

    if (!endpoint) {
      alert("Worker Translate Endpoint를 먼저 입력하세요.\n예: https://broad-shadow-26ac.kkwak2kg.workers.dev/translate");
      return;
    }

    // UI values
    const data = {
      salute: $("salute").value.trim(),
      speaker: $("speaker").value.trim(),
      category: $("category").value,
      when: $("when").value,
      bodyKo: $("bodyKo").value.trim()
    };

    // Reset outputs
    ["KO","EN","JA"].forEach(l => { writeOut(l, ""); setBoxStatus(l, "-", true); });
    setPill("시작...", "warn");

    // Always show KO as original (if selected)
    const doKO = $("langKO").checked;
    const doEN = $("langEN").checked;
    const doJA = $("langJA").checked;

    if (doKO) {
      setBoxStatus("KO", "LOCAL", true);
      writeOut("KO", data.bodyKo);
    } else {
      setBoxStatus("KO", "SKIP", true);
      writeOut("KO", "");
    }

    const targets = [];
    if (doEN) targets.push({ code:"EN", targetLabel:"English", modelHint:"auto" });
    if (doJA) targets.push({ code:"JA", targetLabel:"Japanese", modelHint:"auto" });

    if (targets.length === 0) {
      setPill("완료 (번역 대상 없음)", "ok");
      return;
    }

    // Sequential translate (simple + reliable)
    for (const t of targets) {
      try {
        setBoxStatus(t.code, "REQUEST...", true);

        // Payload: Worker 쪽이 어떤 포맷을 받는지 몰라서 호환성을 넓게 잡음.
        // - 권장: Worker에서 { model, messages } 받는 형태라면 그대로 먹습니다.
        const prompt = buildPrompt({ ...data, target: t.targetLabel });

        const payload = {
          // Worker가 Groq chat.completions 프록시라면 아래 형태가 가장 범용
          model: "llama-3.1-8b-instant",
          messages: [
            { role: "system", content: "You are a helpful translation assistant." },
            { role: "user", content: prompt }
          ]
        };

        const json = await callWorkerTranslate(endpoint, token, payload);
        const out = extractTextFromResponse(json);

        setBoxStatus(t.code, "OK", true);
        writeOut(t.code, out);
      } catch (e) {
        const st = e.status ? `ERR ${e.status}` : "ERR";
        setBoxStatus(t.code, st, false);
        writeOut(t.code, (e && e.message) ? e.message : String(e));

        // 401이면 토큰 문제를 더 친절히 안내
        if (e.status === 401) {
          setPill("401: X-Translate-Token 누락/불일치", "bad");
        } else if (e.status === 403) {
          setPill("403: 서버/업스트림 거부(키/권한/CORS/토큰 등)", "bad");
        } else {
          setPill("오류 발생", "bad");
        }
      }
    }

    // Done
    const anyErr = ["EN","JA"].some(l => $("box"+l).classList.contains("err"));
    setPill(anyErr ? "완료(일부 실패)" : "완료", anyErr ? "warn" : "ok");
  });
</script>
</body>
</html>
