<!DOCTYPE html>
<html lang="ko">
<head>
  <script>
  function getSelectedLangsSafe(){
    const boxes = Array.from(document.querySelectorAll('input.lang[type="checkbox"]'));
    const langs = boxes.filter(b=>b.checked).map(b=>b.value);
    return langs.length ? langs : ["KO"];
  }

  // âœ… ìºì‹œ/SW ê¼¬ì„ ë°©ì§€: ë‚¨ì•„ìˆìœ¼ë©´ í•´ì œ
  (async () => {
    try {
      if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
      }
      if (window.caches) {
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
      }
    } catch (e) {}
  })();

  window.__safeGenerate = function(){
    try{
      if(typeof window.generate === 'function'){
        const r = window.generate();
        if(r && typeof r.then === 'function'){
          r.catch((e)=>{
            console.error(e);
            alert('ê³µì§€ ìƒì„± ë¡œì§ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (F12 ì½˜ì†”ì„ í™•ì¸í•´ ì£¼ì„¸ìš”)');
          });
        }
        return r;
      }
    }catch(e){ console.error(e); }
    alert('ê³µì§€ ìƒì„± ë¡œì§ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (F12 ì½˜ì†”ì„ í™•ì¸í•´ ì£¼ì„¸ìš”)');
    return false;
  };

  function renderResults(map){
    const resArea = document.getElementById("resArea");
    const tabH = document.getElementById("tabH");
    const tabB = document.getElementById("tabB");
    if(!resArea || !tabH || !tabB) return;
    resArea.style.display = "block";
    const langs = Object.keys(map);
    tabH.innerHTML = langs.map((l,i)=>`<button class="tab ${i===0?'active':''}" data-lang="${l}">${l}</button>`).join("");
    tabB.innerHTML = langs.map((l,i)=>`<div class="tab-pane ${i===0?'active':''}" data-lang="${l}"><pre class="out-pre"></pre></div>`).join("");
    langs.forEach((l)=>{
      const pane = tabB.querySelector(`.tab-pane[data-lang="${l}"] pre`);
      if(pane) pane.textContent = map[l] || "";
    });
    tabH.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        tabH.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
        tabB.querySelectorAll(".tab-pane").forEach(p=>p.classList.remove("active"));
        btn.classList.add("active");
        const l = btn.dataset.lang;
        tabB.querySelector(`.tab-pane[data-lang="${l}"]`).classList.add("active");
      });
    });
  }
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Professional Notice Master v40.7 (Groq-only ë²ˆì—­ + í‚¤ sanitize + worker-block)</title>

  <style>
    body { background-color:#0f172a; color:#f8fafc; font-family:'Pretendard',system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; display:flex; justify-content:center; padding:20px; }
    .container { width:100%; max-width:980px; background:#1e293b; padding:40px; border-radius:24px; box-shadow:0 20px 50px rgba(0,0,0,.6); border:1px solid #334155; }
    h1 { text-align:center; color:#22d3ee; margin:0 0 10px; font-size:26px; font-weight:900; }
    .sub { text-align:center; color:#94a3b8; margin:0 0 26px; font-size:13px; line-height:1.6; }

    .form-group { margin-bottom:18px; }
    label { display:block; margin-bottom:10px; color:#94a3b8; font-weight:900; font-size:14px; }
    input, select, textarea { width:100%; padding:14px; background:#0f172a; border:1px solid #334155; color:#fff; border-radius:12px; box-sizing:border-box; font-size:15px; outline:none; }
    textarea { resize: vertical; min-height: 90px; }
    input:focus, select:focus, textarea:focus { border-color:#22d3ee; box-shadow:0 0 0 3px rgba(34,211,238,.18); }

    .row { display:flex; gap:15px; flex-wrap:wrap; }
    .row > .form-group { flex:1; min-width:250px; }

    .lang-group { display:flex; gap:15px; background:#0f172a; padding:12px 20px; border-radius:12px; border:1px solid #334155; align-items:center; flex-wrap:wrap; }
    .lang-group label { margin:0; font-size:13px; color:#e2e8f0; font-weight:900; display:flex; align-items:center; gap:8px; }
    .lang-group input { width:auto; padding:0; }

    .helper { color:#94a3b8; font-size:12px; margin-top:8px; line-height:1.6; }

    .pillbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .pill { font-size:12px; color:#94a3b8; border:1px solid #334155; background:#0f172a; padding:8px 10px; border-radius:999px; }
    .pill.ok { color:#9be7b1; border-color:rgba(155,231,177,.35); }
    .pill.info { color:#a5b4fc; border-color:rgba(165,180,252,.35); }
    .pill.warn { color:#ffd38a; border-color:rgba(255,211,138,.35); }
    .pill.bad { color:#fb7185; border-color:rgba(251,113,133,.35); }

    .make-btn { width:100%; padding:20px; background:linear-gradient(135deg,#22d3ee,#0ea5e9); color:#0f172a; border:none; font-weight:900; border-radius:14px; cursor:pointer; font-size:18px; margin-top:10px; }
    .make-btn:active { transform:translateY(1px); }

    #loading { display:none; text-align:center; color:#22d3ee; margin:18px 0; font-weight:900; }

    .tabs { display:flex; margin-top:26px; gap:6px; }
    .tab-btn { flex:1; padding:14px; background:#334155; border:none; color:#94a3b8; cursor:pointer; border-radius:12px 12px 0 0; font-weight:900; }
    .tab-btn.active { background:#22d3ee; color:#0f172a; }

    .result-box { background:#0f172a; padding:28px 30px; border-radius:0 15px 15px 15px; white-space:pre-wrap; min-height:360px; border:1px solid #334155; border-top:none; font-size:16px; line-height:2.15; color:#e2e8f0; }

    .copy-btn { width:100%; padding:16px; background:#475569; color:#fff; border-radius:12px; cursor:pointer; margin-top:16px; font-weight:900; border:none; }

    .hidden { display:none !important; }

    .warnbox { margin: 14px 0 0; padding: 14px 16px; background:#0f172a; border:1px solid rgba(255,211,138,.35); border-left:5px solid #ffd38a; border-radius:12px; color:#e2e8f0; font-size:13px; line-height:1.6; }
    .warnbox b { color:#ffd38a; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
  </style>
</head>

<body>
<div class="container">
  <h1>ğŸ® Professional Notice Master v40.7</h1>
  <div class="sub">
    ì˜ˆì „ UI ìœ ì§€ + <b>[object Object]</b> ì™„ì „ ì œê±° + <b>Issue êµ¬ì¡°(í˜„ìƒâ†’ì‚¬ê³¼â†’ì¡°ì¹˜â†’ì¶”ê°€ ì•ˆë‚´)</b> ê³ ì •<br/>
    ë‹¤êµ­ì–´(EN/JA)ëŠ” <b>Groq APIë¡œë§Œ ë²ˆì—­</b>í•©ë‹ˆë‹¤. (ì›Œì»¤ í˜¸ì¶œ X â†’ CORS ì˜¤ë¥˜ ì œê±°)
  </div>

  <div class="warnbox">
    <b>í•„ìˆ˜</b>: ë‹¤êµ­ì–´ ë²ˆì—­ì€ Groq í‚¤ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.<br/>
    ì½˜ì†”ì—ì„œ 1íšŒ ì‹¤í–‰: <code>localStorage.setItem("GROQ_API_KEY","gsk_...")</code><br/>
    â€» í‚¤ëŠ” ê³µë°±/ì¤„ë°”ê¿ˆ/í•œê¸€ì´ ì„ì´ë©´ ì‹¤íŒ¨í•  ìˆ˜ ìˆì–´ ìë™ìœ¼ë¡œ ì •ë¦¬(sanitize)í•©ë‹ˆë‹¤.
  </div>

  <div class="row" style="margin-top:18px;">
    <div class="form-group">
      <label>ìœ ì € í˜¸ì¹­</label>
      <input type="text" id="userTitle" value="ëª¨í—˜ê°€ ì—¬ëŸ¬ë¶„">
    </div>
    <div class="form-group">
      <label>í™”ìëª…</label>
      <input type="text" id="speakerName" value="ë°”ë°”">
      <div class="helper">KO 1ë¬¸ë‹¨ ê³ ì •: <code>ì•ˆë…•í•˜ì„¸ìš” {í˜¸ì¹­}, {í™”ì}ì…ë‹ˆë‹¤.</code></div>
    </div>
  </div>

  <div class="row">
    <div class="form-group">
      <label>ì–¸ì–´ ì„ íƒ</label>
      <div class="lang-group">
        <label><input type="checkbox" class="lang" value="KO" checked> KO</label>
        <label><input type="checkbox" class="lang" value="EN"> EN</label>
        <label><input type="checkbox" class="lang" value="JA"> JA</label>
      </div>
    </div>
    <div class="form-group">
      <label>ê³µì§€ ìœ í˜•</label>
      <select id="noticeType">
        <option value="issue" selected>ì´ìŠˆ í˜„ìƒ ì•ˆë‚´</option>
        <option value="maint">ì ê²€ ì•ˆë‚´</option>
        <option value="done">ì¡°ì¹˜ ì™„ë£Œ ì•ˆë‚´</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div class="form-group">
      <label>ì¼ì‹œ í˜•ì‹</label>
      <select id="dtFormat">
        <option value="slash">MM/DD HH:MM</option>
        <option value="korean">Mì›” Dì¼ HH:MM</option>
      </select>
      <div class="pillbar">
        <span class="pill info" id="pillTemplate">í…œí”Œë¦¿: -</span>
        <span class="pill ok" id="pillApology">ì‚¬ê³¼: ê¸°ë³¸ í¬í•¨</span>
        <span class="pill warn" id="pillTranslate">ë²ˆì—­: ì¤€ë¹„</span>
      </div>
    </div>
    <div class="form-group" style="display:none;">
      <label>ì ê²€ ë¬¸ì¥ ìŠ¤íƒ€ì¼</label>
      <select id="fixVerb">
        <option value="ìˆ˜ì •" selected>ìˆ˜ì •</option>
        <option value="í•´ê²°">í•´ê²°</option>
      </select>
    </div>
  </div>

  <!-- ì ê²€ -->
  <div id="maintSection" class="hidden">
    <div class="row">
      <div class="form-group">
        <label>ì ê²€ ì¢…ë¥˜</label>
        <select id="maintKind" onchange="syncMaintSubtitle();">
          <option value="ê¸´ê¸‰" selected>ê¸´ê¸‰ ì ê²€</option>
          <option value="ì„ì‹œ">ì„ì‹œ ì ê²€</option>
          <option value="ì •ê¸°">ì •ê¸° ì ê²€</option>
        </select>
      </div>
      <div class="form-group">
        <label>ì ê²€ ìƒíƒœ</label>
        <select id="maintStatus" onchange="syncMaintSubtitle();">
          <option value="planned" selected>ì§„í–‰ ì˜ˆì •</option>
          <option value="ongoing">ì§„í–‰ ì¤‘</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label>ì ê²€ ëª©ì </label>
      <input type="text" id="maintPurpose" placeholder="ì˜ˆ: ë°°ë„ˆ ë¯¸ë…¸ì¶œ í˜„ìƒ ìˆ˜ì • / ìºë¦­í„° ìƒì„± ë¶ˆê°€">
    </div>

    <div class="row">
      <div class="form-group">
        <label>ìƒì„¸ ë¸”ë¡ ì†Œì œëª©(ëŒ€ê´„í˜¸ ìë™ ì²˜ë¦¬)</label>
        <input type="text" id="maintSubtitle" value="ê¸´ê¸‰ ì ê²€ ì§„í–‰ ì˜ˆì • ì•ˆë‚´">
      </div>
      <div class="form-group">
        <label>ì ê²€ ë‚´ìš©(ì„ íƒ)</label>
        <input type="text" id="maintContent" placeholder="ì˜ˆ: ë°°ë„ˆ ë¯¸ë…¸ì¶œ í˜„ìƒ ìˆ˜ì •">
      </div>
    </div>

    <div class="row">
      <div class="form-group">
        <label>ì ê²€ ì‹œì‘</label>
        <input type="datetime-local" id="maintStart">
      </div>
      <div class="form-group">
        <label>ì ê²€ ì¢…ë£Œ</label>
        <input type="datetime-local" id="maintEnd">
      </div>
    </div>

    <div class="row">
      <div class="form-group">
        <label>ì´ìš© ì˜í–¥(ì„ íƒ)</label>
        <input type="text" id="impact" placeholder="ì˜ˆ: ì ê²€ ì‹œê°„ ë™ì•ˆ ê²Œì„ ì ‘ì†ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤">
      </div>
      <div class="form-group">
        <label>ì´ìš© ì˜í–¥ ë¬¸ì¥ í¬í•¨</label>
        <select id="impactInclude">
          <option value="no" selected>ë¯¸í¬í•¨(ê¸°ë³¸)</option>
          <option value="yes">í¬í•¨</option>
        </select>
      </div>
    </div>
  </div>

  <!-- ì´ìŠˆ -->
  <div id="issueSection">
    <div class="row">
      <div class="form-group">
        <label>ì´ìš© ì˜í–¥ì´ í™•ì‹¤í•œê°€ìš”?</label>
        <select id="impactSure">
          <option value="yes" selected>ì˜ˆ (ì‚¬ê³¼ í¬í•¨)</option>
          <option value="no">ì•„ë‹ˆì˜¤ (ì‚¬ê³¼ ë¯¸í¬í•¨)</option>
        </select>
        <div class="helper">ì´ìŠˆ ê³µì§€ì˜ ì‚¬ê³¼ ë¬¸êµ¬ í¬í•¨ ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.</div>
      </div>
      <div class="form-group">
        <label> </label>
        <div class="helper" style="margin-top:30px;"></div>
      </div>
    </div>
    <div class="row">
      <div class="form-group">
        <label>ë°œìƒ/í™•ì¸ ì¼ì‹œ</label>
        <input type="datetime-local" id="issueDt">
      </div>
      <div class="form-group">
        <label>í˜„ìƒ ì…ë ¥</label>
        <input type="text" id="issueText" placeholder="ì˜ˆ: ì ‘ì† ë¶ˆê°€ í˜„ìƒ">
      </div>
    </div>
  </div>

  <!-- ì¡°ì¹˜ì™„ë£Œ -->
  <div id="doneSection" class="hidden">
    <div class="row">
      <div class="form-group">
        <label>ì´ìš© ì˜í–¥ì´ í™•ì‹¤í•œê°€ìš”?</label>
        <select id="doneImpactSure">
          <option value="yes" selected>ì˜ˆ (ì‚¬ê³¼ í¬í•¨)</option>
          <option value="no">ì•„ë‹ˆì˜¤ (ì‚¬ê³¼ ë¯¸í¬í•¨)</option>
        </select>
      </div>
      <div class="form-group">
        <label> </label>
        <div class="helper" style="margin-top:30px;"></div>
      </div>
    </div>
    <div class="row">
      <div class="form-group">
        <label>ì¡°ì¹˜ ëŒ€ìƒ í˜„ìƒ</label>
        <input type="text" id="doneIssue" placeholder="ì˜ˆ: íŒ¨í‚¤ì§€ êµ¬ë§¤ ë¶ˆê°€ í˜„ìƒ">
      </div>
      <div class="form-group">
        <label>ì¡°ì¹˜ ì™„ë£Œ ì‹œê°(ì„ íƒ)</label>
        <input type="datetime-local" id="doneDt">
      </div>
    </div>
    <div class="form-group">
      <label>ì¶”ê°€ ì•ˆë‚´(ì„ íƒ)</label>
      <input type="text" id="doneExtra" placeholder="ì˜ˆ: í˜„ì¬ëŠ” ì •ìƒì ìœ¼ë¡œ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤">
    </div>
  </div>

  <button class="make-btn" onclick="return window.__safeGenerate && window.__safeGenerate()">ê³µì§€ ìƒì„±</button>
  <div id="loading">ğŸ¤– ìƒì„± ì¤‘...</div>

  <div id="resArea" style="display:none;">
    <div class="tabs" id="tabH"></div>
    <div class="result-box" id="tabB"></div>
    <button class="copy-btn" onclick="copyAll()">ê³µì§€ ë³¸ë¬¸ ë³µì‚¬</button>
  </div>
</div>

<script>
  // =========================
  // CONFIG
  // =========================
  const LS_KEY_NAME = "GROQ_API_KEY";
  const GROQ_MODEL_CANDIDATES = ["llama3-70b-8192", "llama-3.1-70b-versatile", "llama3-8b-8192"];
  const APP_VERSION = "v40.7";
  console.log("[NoticeMaster]", APP_VERSION, "loaded");

  // âœ… ë°©ì–´ë§‰: ì–´ë–¤ ì½”ë“œê°€ ë‚¨ì•„ìˆë”ë¼ë„ ì›Œì»¤(translate) í˜¸ì¶œì€ ì°¨ë‹¨ (CORS ì†ŒìŒ ì œê±°)
  (function blockWorkerTranslate(){
    const _fetch = window.fetch;
    if(typeof _fetch !== "function") return;
    window.fetch = function(input, init){
      try{
        const url = (typeof input === "string") ? input : (input && input.url) ? input.url : "";
        if(url && url && url.includes("notice" + "-translate" + ".kkwak2kg" + ".workers" + ".dev")){
          throw new Error("Worker translate is disabled (Groq-only). Please deploy the latest index.html.");
        }
      }catch(e){
        // if we throw above, it will be caught by caller anyway
        if(String(e && e.message).includes("Worker translate is disabled")) throw e;
      }
      return _fetch.apply(this, arguments);
    };
  })();



  function getApiKey(){
    const raw = (localStorage.getItem(LS_KEY_NAME) || "");
    // âœ… í—¤ë” ì—ëŸ¬ ë°©ì§€: ê³µë°±/ê°œí–‰ ì œê±° + ë”°ì˜´í‘œ ì œê±° + ë¹„ASCII ì œê±°
    return raw
      .trim()
      .replace(/^["']|["']$/g, "")
      .replace(/\s+/g, "")
      .replace(/[^\x20-\x7E]/g, "");
  }

  // âœ… ì•ˆì „ ë¬¸ìì—´í™”: [object Object] ì™„ì „ ì œê±°
  function safeToText(value){
    if(value === null) return "null";
    if(value === undefined) return "";
    if(typeof value === "string") return value;
    if(typeof value === "number" || typeof value === "boolean" || typeof value === "bigint") return String(value);
    if(value instanceof Date) return value.toISOString?.() || String(value);
    if(value instanceof Error) return value.stack || value.message || String(value);
    try{
      const seen = new WeakSet();
      const json = JSON.stringify(value, (k,v)=>{
        if(typeof v === "bigint") return v.toString();
        if(typeof v === "function") return `[Function${v.name ? ":"+v.name : ""}]`;
        if(typeof v === "object" && v !== null){
          if(seen.has(v)) return "[Circular]";
          seen.add(v);
        }
        return v;
      }, 2);
      return (json === undefined) ? "[Unserializable]" : json;
    }catch{
      const tag = Object.prototype.toString.call(value);
      return tag === "[object Object]" ? "[Unserializable Object]" : tag;
    }
  }

  const $ = (id)=>document.getElementById(id);
  function bindGlobals(){
    const ids = [
      "noticeType","loading","resArea","tabH","tabB","pillTemplate","pillApology","pillTranslate",
      "dtFormat","userTitle","speakerName",
      "issueDt","issueText","impact","impactSure",
      "maintKind","maintStatus","maintPurpose","maintSubtitle","maintContent","maintStart","maintEnd","impactInclude",
      "doneIssue","doneDt","doneExtra","doneImpactSure",
      "fixVerb"
    ];
    ids.forEach(id=>{ const el = $(id); if(el) window[id]=el; });
  }
  document.addEventListener("DOMContentLoaded", bindGlobals);

  let savedResults = {};

  function pad2(n){ return String(n).padStart(2,'0'); }
  function formatDT(dtStr, fmt){
    if(!dtStr) return "";
    const d = new Date(dtStr);
    if(Number.isNaN(d.getTime())) return "";
    const m = d.getMonth()+1;
    const day = d.getDate();
    const hh = pad2(d.getHours());
    const mm = pad2(d.getMinutes());
    if(fmt === "korean") return `${m}ì›” ${day}ì¼ ${hh}:${mm}`;
    return `${pad2(m)}/${pad2(day)} ${hh}:${mm}`;
  }
  function diffText(startStr, endStr){
    if(!startStr || !endStr) return "";
    const s = new Date(startStr);
    const e = new Date(endStr);
    if(Number.isNaN(s.getTime()) || Number.isNaN(e.getTime())) return "";
    let mins = Math.round((e - s) / 60000);
    if(mins <= 0) return "";
    const h = Math.floor(mins / 60);
    const m = mins % 60;
    if(h > 0 && m > 0) return `(${h}ì‹œê°„ ${m}ë¶„)`;
    if(h > 0) return `(${h}ì‹œê°„)`;
    return `(${m}ë¶„)`;
  }

  function syncMaintSubtitle(){
    const kind = maintKind.value;
    const status = maintStatus.value === "planned" ? "ì§„í–‰ ì˜ˆì • ì•ˆë‚´" : "ì§„í–‰ ì•ˆë‚´";
    maintSubtitle.value = `${kind} ì ê²€ ${status}`;
  }

  function refreshPills(){
    pillTemplate.textContent = "í…œí”Œë¦¿: " + noticeType.options[noticeType.selectedIndex].text;
  }

  function setTranslatePill(text, mode){
    const el = $("pillTranslate");
    if(!el) return;
    el.textContent = text;
    el.classList.remove("ok","info","warn","bad");
    el.classList.add(mode || "warn");
  }

  function cleanBracketTitle(s){
    if(!s) return "";
    let t = String(s).trim();
    if((t.startsWith("[") && t.endsWith("]")) || (t.startsWith("(") && t.endsWith(")"))){
      t = t.slice(1,-1).trim();
    }
    return t;
  }

  function normalizePurpose(purpose){
    return String(purpose || "").replace(/\s*(ìˆ˜ì •|í•´ê²°|ì¡°ì¹˜)\s*$/g, "").trim();
  }

  function ensurePhenomenonPhrase(base){
    const t = String(base || "").trim();
    if(!t) return "";
    if(t.endsWith("í˜„ìƒ")) return t;
    return t + " í˜„ìƒ";
  }

  function buildMaintBlock(subtitle, windowText, content){
    const sub = cleanBracketTitle(subtitle) || "ì ê²€ ì•ˆë‚´";
    const cont = (content || "").trim();
    return `[${sub}]\n- ì§„í–‰ ì¼ì‹œ: ${windowText}\n- ì ê²€ ë‚´ìš©: ${cont}\n\nì ê²€ì´ ì•ˆë‚´í•´ ë“œë¦° ì‹œê°„ë³´ë‹¤ ì¡°ê¸° ì¢…ë£Œë˜ê±°ë‚˜ ì—°ì¥ë  ê²½ìš° ë³„ë„ ê³µì§€ë¥¼ í†µí•´ ë‹¤ì‹œ í•œë²ˆ ì•ˆë‚´í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.`;
  }

  function josa(word, pair){
    const w = (word||"").trim();
    if(!w) return pair.split("/")[0];
    const last = w.charCodeAt(w.length-1);
    const isHangul = (last >= 0xAC00 && last <= 0xD7A3);
    if(!isHangul) return pair.split("/")[0];
    const jong = (last - 0xAC00) % 28;
    const hasJong = jong !== 0;
    const [a,b] = pair.split("/");
    if(pair==="ìœ¼ë¡œ/ë¡œ"){
      return (!hasJong || jong===8) ? b : a;
    }
    return hasJong ? a : b;
  }

  // âœ… KO ì´ìŠˆ ê³µì§€: êµ¬ì¡° ê³ ì • + ê°ì²´ ë¬¸ìì—´í™” ë°©ì§€
  function buildIssueTextKO(payload){
    const caller = safeToText((payload.speaker||"").trim() || "ë°”ë°”");
    const honor  = safeToText((payload.userTitle||"").trim() || "ëª¨í—˜ê°€ ì—¬ëŸ¬ë¶„");
    const dtFmt  = payload.dtFormat || "slash";

    const issueObj = (payload && payload.issue && typeof payload.issue === "object") ? payload.issue : {};
    const whenRaw = issueObj.dtRaw || payload.issueAt || payload.issueDt || "";
    const timeStr = formatDT(whenRaw, dtFmt);
    const timeStrSafe = safeToText(timeStr || String(whenRaw || "").trim()).trim();

    const phenomenonRaw = issueObj.text || payload.issueText || payload.issueDesc || "";
    const phenomenon = safeToText(phenomenonRaw).trim();

    const impactSureVal = issueObj.apology || payload.impactSure || "yes";
    const impactSure = String(impactSureVal).toLowerCase() !== "no";

    const g = josa(phenomenon, "ì´/ê°€");

    const lines = [];
    lines.push(`ì•ˆë…•í•˜ì„¸ìš” ${honor}, ${caller}ì…ë‹ˆë‹¤.`);
    lines.push("");

    // 1) í˜„ìƒ
    if(timeStrSafe){
      lines.push(`${timeStrSafe}ë¶€í„° ${phenomenon || "ì¼ë¶€ í˜„ìƒ"}${g} ë°œìƒí•˜ì—¬ ì•ˆë‚´í•´ ë“œë¦½ë‹ˆë‹¤.`);
    }else{
      lines.push(`${phenomenon || "ì¼ë¶€ í˜„ìƒ"}${g} ë°œìƒí•˜ì—¬ ì•ˆë‚´í•´ ë“œë¦½ë‹ˆë‹¤.`);
    }
    lines.push("");

    // 2) ì‚¬ê³¼
    if(impactSure){
      lines.push(`í•´ë‹¹ í˜„ìƒìœ¼ë¡œ ì´ìš©ì— ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•˜ë‹¤ëŠ” ë§ì”€ì„ ë“œë¦½ë‹ˆë‹¤.`);
      lines.push("");
    }

    // 3) ì¡°ì¹˜
    lines.push(`í˜„ì¬ ì›ì¸ íŒŒì•… ë° ì¡°ì¹˜ë¥¼ ì§„í–‰ ì¤‘ì´ë©°, ì›í™œí•œ ì´ìš©ì´ ê°€ëŠ¥í•˜ë„ë¡ ì‹ ì†íˆ ì²˜ë¦¬í•˜ê² ìŠµë‹ˆë‹¤.`);
    lines.push("");

    // 4) ì¶”ê°€ ì•ˆë‚´
    lines.push(`ì´í›„ ì§„í–‰ë˜ëŠ” ì‚¬í•­ì— ëŒ€í•´ì„œëŠ” ë³„ë„ ê³µì§€ë¥¼ í†µí•´ ë‹¤ì‹œ í•œë²ˆ ì•ˆë‚´í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.`);
    lines.push("");
    lines.push("ê°ì‚¬í•©ë‹ˆë‹¤.");

    return lines.join("\n");
  }

  function buildMaintTextKO(payload){
    const p1 = `ì•ˆë…•í•˜ì„¸ìš” ${safeToText(payload.userTitle)}, ${safeToText(payload.speaker)}ì…ë‹ˆë‹¤.`;

    const base = normalizePurpose(payload.maint.purpose) || payload.maint.purpose;
    const subject = ensurePhenomenonPhrase(base);

    const kind = payload.maint.kind;
    const status = payload.maint.status;
    const verb = (payload.maint.fixVerb === "í•´ê²°") ? "í•´ê²°" : "ìˆ˜ì •";
    const startFmt = formatDT(payload.maint.startRaw, payload.dtFormat);
    const endFmt = formatDT(payload.maint.endRaw, payload.dtFormat);

    const timeLead = startFmt ? `${startFmt}ë¶€í„° ` : "";
    const timeRangeTail = (startFmt && endFmt) ? `${endFmt}ê¹Œì§€ ` : "";

    // âœ… ì¸ê³¼ ìœ ì§€
    const p2 = (status === "ongoing")
      ? `${timeLead}${subject} ${verb}ì„ ìœ„í•´ ${kind} ì ê²€ì´ ì§„í–‰ë˜ê³  ìˆì–´ ì•ˆë‚´í•´ ë“œë¦½ë‹ˆë‹¤.`
      : `${timeLead}${timeRangeTail}${subject} ${verb}ì„ ìœ„í•´ ${kind} ì ê²€ì„ ì§„í–‰í•  ì˜ˆì •ì„ì„ ì•ˆë‚´í•´ ë“œë¦½ë‹ˆë‹¤.`;

    let p3 = `í•´ë‹¹ í˜„ìƒìœ¼ë¡œ ì´ìš©ì— ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•˜ë‹¤ëŠ” ë§ì”€ì„ ë“œë¦¬ë©°, ì ê²€ì„ í†µí•´ ì¡°ì¹˜í•˜ì—¬ ì›í™œí•œ í”Œë ˆì´ í™˜ê²½ì„ ì œê³µí•´ ë“œë¦´ ìˆ˜ ìˆë„ë¡ ë…¸ë ¥í•˜ê² ìŠµë‹ˆë‹¤.`;

    if(payload.maint.impactInclude === "yes" && payload.maint.impact){
      const line = payload.maint.impact.trim();
      if(line) p3 = p3 + `\n${line}`;
    }

    const block = buildMaintBlock(payload.maint.subtitle, payload.maint.windowText, payload.maint.content || payload.maint.purpose);
    const p5 = "ê°ì‚¬í•©ë‹ˆë‹¤.";
    return [p1, p2, p3, block, p5].join("\n\n");
  }

  function buildDoneTextKO(payload){
    const caller = (payload.speaker||"").trim() || "ìš´ì˜íŒ€";
    const honor  = (payload.userTitle||"").trim() || "ëª¨í—˜ê°€ ì—¬ëŸ¬ë¶„";
    const dtFmt  = payload.dtFormat || "slash";

    const done = payload.done || {};
    const issue = safeToText(done.issue || "").trim() || "ì´ìš© ë¶ˆê°€ í˜„ìƒ";
    const endRaw = done.dtRaw || "";
    const endStr = endRaw ? formatDT(endRaw, dtFmt) : "";
    const impactSure = (done.impactSure || "yes") === "yes";
    const extra = safeToText(done.extra || "").trim();

    const obj = josa(issue, "ì„/ë¥¼");

    const lines = [];
    lines.push(`ì•ˆë…•í•˜ì„¸ìš” ${honor}, ${caller}ì…ë‹ˆë‹¤.`);
    lines.push("");

    if(endStr){
      lines.push(`ì•ì„œ ì•ˆë‚´í•´ ë“œë ¸ë˜ ${issue}${obj} ${endStr} ê²½ ì¡°ì¹˜ ì™„ë£Œí•˜ì—¬ í˜„ì¬ëŠ” ì •ìƒì ìœ¼ë¡œ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
    }else{
      lines.push(`ì•ì„œ ì•ˆë‚´í•´ ë“œë ¸ë˜ ${issue}${obj} ì¡°ì¹˜ ì™„ë£Œí•˜ì—¬ í˜„ì¬ëŠ” ì •ìƒì ìœ¼ë¡œ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
    }

    if(extra){
      lines.push("");
      lines.push(extra.endsWith(".") ? extra : (extra + "."));
    }

    lines.push("");
    if(impactSure){
      lines.push("í•´ë‹¹ í˜„ìƒìœ¼ë¡œ ì¸í•´ ì´ìš©ì— ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•˜ë‹¤ëŠ” ë§ì”€ì„ ë“œë¦¬ë©°,");
    }
    lines.push("ì•ìœ¼ë¡œ ë” ì•ˆì •ì ì¸ ì„œë¹„ìŠ¤ ì œê³µì„ ìœ„í•´ ìµœì„ ì„ ë‹¤í•˜ê² ìŠµë‹ˆë‹¤.");
    lines.push("");
    lines.push("ê°ì‚¬í•©ë‹ˆë‹¤.");
    return lines.join("\n");
  }

  function buildKOText(payload){
    const t = payload.noticeType || payload.type;
    if(t==="maint") return buildMaintTextKO(payload);
    if(t==="done") return buildDoneTextKO(payload);
    return buildIssueTextKO(payload);
  }

  // =========================
  // Groq translation (ONLY)
  // =========================
  async function groqTranslateOne(koreanNotice, target){
    const apiKey = getApiKey();
    if(!apiKey) throw new Error("NO_GROQ_KEY");

    const targetName = target === "EN" ? "English" : target === "JA" ? "Japanese" : target;
    const sys =
`You are a professional game live-ops localization specialist.
Translate Korean service notices into ${targetName}.
Keep a polite, clear tone.
Preserve line breaks and structure.
Do NOT add extra information.
Do NOT add greetings that are not in the original.
Return only the translated text.`;

    let lastErr = null;

    for(const model of GROQ_MODEL_CANDIDATES){
      try{
        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + apiKey
          },
          body: JSON.stringify({
            model,
            temperature: 0.2,
            messages: [
              { role: "system", content: sys },
              { role: "user", content: String(koreanNotice || "") }
            ]
          })
        });

        if(!res.ok){
          const t = await res.text().catch(()=> "");
          throw new Error(`GROQ_${model}_HTTP_${res.status}: ${t}`);
        }

        const data = await res.json();
        const text = data?.choices?.[0]?.message?.content;
        if(typeof text !== "string" || !text.trim()){
          throw new Error(`GROQ_${model}_EMPTY`);
        }
        return text.trim();
      }catch(e){
        lastErr = e;
      }
    }
    throw lastErr || new Error("GROQ_FAILED");
  }

  async function groqTranslateMany(koreanNotice, langs){
    const targets = (langs || []).filter(l => l !== "KO");
    const out = {};
    if(!targets.length) return out;

    setTranslatePill("ë²ˆì—­: Groq", "info");
    for(const t of targets){
      out[t] = await groqTranslateOne(koreanNotice, t);
    }
    setTranslatePill("ë²ˆì—­: ì™„ë£Œ", "ok");
    return out;
  }

  // =========================
  // Render
  // =========================
  function renderTabs(langs){
    tabH.innerHTML="";
    langs.forEach((l,i)=>{
      const b=document.createElement("button");
      b.className="tab-btn"+(i===0?" active":"");
      b.innerText=l;
      b.onclick=()=>{
        document.querySelectorAll(".tab-btn").forEach(t=>t.classList.remove("active"));
        b.classList.add("active");
        updateDisplay(l);
      };
      tabH.appendChild(b);
    });
    resArea.style.display="block";
    updateDisplay(langs[0]);
  }

  function updateDisplay(lang){
    tabB.innerText = savedResults?.[lang]?.notice || "";
  }

  function copyAll(){
    navigator.clipboard.writeText(tabB.innerText);
    alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }

  function toggleSections(){
    const typeEl = document.getElementById("noticeType");
    const type = typeEl ? typeEl.value : "issue";

    const maint = document.getElementById("maintSection");
    const issue = document.getElementById("issueSection");
    const done  = document.getElementById("doneSection");

    if(maint) maint.classList.toggle("hidden", type !== "maint");
    if(issue) issue.classList.toggle("hidden", type !== "issue");
    if(done)  done.classList.toggle("hidden", type !== "done");

    const pill = document.getElementById("pillTemplate");
    if(pill && typeEl){
      pill.textContent = "í…œí”Œë¦¿: " + typeEl.options[typeEl.selectedIndex].text;
    }
  }

  function initUI(){
    try{
      const typeEl = document.getElementById("noticeType");
      if(typeEl){
        typeEl.addEventListener("change", () => {
          toggleSections();
          refreshPills();
        });
      }
    }catch(e){}
    try{ toggleSections(); }catch(e){}
  }
  document.addEventListener("DOMContentLoaded", initUI);

  // =========================
  // Main generate
  // =========================
  async function generate(){
    bindGlobals();
    const langs = [...document.querySelectorAll(".lang:checked")].map(e=>e.value);
    if(!langs.length) return alert("ì–¸ì–´ë¥¼ 1ê°œ ì´ìƒ ì„ íƒí•´ ì£¼ì„¸ìš”.");

    const type = noticeType.value;
    const dtFmt = dtFormat.value;

    loading.style.display="block";
    resArea.style.display="none";
    setTranslatePill("ë²ˆì—­: ì¤€ë¹„", "warn");

    const payload = {
      type,
      userTitle: (userTitle.value.trim() || "ì´ìš©ì ì—¬ëŸ¬ë¶„"),
      speaker: (speakerName.value.trim() || "ìš´ì˜íŒ€"),
      dtFormat: dtFmt,
      langs,
      maint: {},
      issue: {},
      done: {}
    };

    try{
      if(type === "maint"){
        if(!maintPurpose.value.trim()) return alert("ì ê²€ ëª©ì ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        if(!maintStart.value || !maintEnd.value) return alert("ì ê²€ ì‹œì‘/ì¢…ë£Œ ì‹œê°„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");

        payload.maint = {
          kind: maintKind.value,
          status: maintStatus.value,
          purpose: maintPurpose.value.trim(),
          subtitle: cleanBracketTitle(maintSubtitle.value),
          content: maintContent.value.trim(),
          startRaw: maintStart.value,
          endRaw: maintEnd.value,
          windowText: `${formatDT(maintStart.value, dtFmt)} ~ ${formatDT(maintEnd.value, dtFmt)} ${diffText(maintStart.value, maintEnd.value)}`.trim(),
          impact: (impact ? impact.value.trim() : ""),
          impactInclude: impactInclude.value,
          fixVerb: fixVerb ? fixVerb.value : "ìˆ˜ì •"
        };
        payload.noticeType = "maint";
      }

      if(type === "issue"){
        if(!issueDt.value) return alert("ë°œìƒ/í™•ì¸ ì¼ì‹œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        if(!issueText.value.trim()) return alert("í˜„ìƒ ì…ë ¥ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”.");

        payload.issue = {
          dtRaw: issueDt.value,
          text: issueText.value.trim(),
          apology: (impactSure ? impactSure.value : "yes")
        };
        payload.issueText = payload.issue.text;
        payload.issueAt = payload.issue.dtRaw;
        payload.impactSure = payload.issue.apology;
        payload.noticeType = "issue";
      }

      if(type === "done"){
        const di = (doneIssue ? doneIssue.value : "").trim();
        const dd = (doneDt ? doneDt.value : "");
        if(!di) return alert("ì¡°ì¹˜ ëŒ€ìƒ í˜„ìƒì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");

        payload.done = {
          issue: di,
          dtRaw: dd,
          extra: (doneExtra ? doneExtra.value : "").trim(),
          impactSure: (doneImpactSure ? doneImpactSure.value : "yes")
        };
        payload.noticeType = "done";
      }

      // âœ… KOëŠ” ë¬´ì¡°ê±´ ìƒì„±
      const koText = buildKOText(payload);

      savedResults = {};
      if(langs.includes("KO")) savedResults.KO = { notice: koText };

      // âœ… EN/JA ì„ íƒ ì‹œ: Groq í‚¤ ì—†ìœ¼ë©´ KOë§Œ + ê²½ê³ 
      const needTr = langs.filter(l => l !== "KO");
      if(needTr.length){
        const k = getApiKey();
        if(!k){
          setTranslatePill("ë²ˆì—­: Groq í‚¤ í•„ìš”", "bad");
          for(const l of needTr){
            savedResults[l] = { notice: "ë²ˆì—­ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (Groq API Keyë¥¼ ì„¤ì •í•´ ì£¼ì„¸ìš”)\n\n" + koText };
          }
        }else{
          try{
            const tr = await groqTranslateMany(koText, langs);
            for(const l of needTr){
              const t = tr[l];
              savedResults[l] = { notice: (typeof t === "string" && t.trim()) ? t.trim() : ("ë²ˆì—­ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n"+koText) };
            }
          }catch(e){
            console.error(e);
            setTranslatePill("ë²ˆì—­: ì‹¤íŒ¨( KOë§Œ )", "bad");
            for(const l of needTr){
              savedResults[l] = { notice: "ë²ˆì—­ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (Groq API ì‘ë‹µ/í‚¤ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”)\n\n" + koText };
            }
          }
        }
      }else{
        setTranslatePill("ë²ˆì—­: ë¯¸ì‚¬ìš©", "warn");
      }

      renderTabs(langs);
    }catch(e){
      console.error(e);
      alert("ìƒì„± ì‹¤íŒ¨: " + (e?.message || e));
    }finally{
      loading.style.display="none";
    }
  }
  window.generate = generate;

  // init defaults
  (function init(){
    toggleSections();
    syncMaintSubtitle();
    refreshPills();
    setTranslatePill("ë²ˆì—­: ì¤€ë¹„", "warn");

    const now = new Date();
    const minutes = now.getMinutes();
    const rounded = Math.round(minutes / 5) * 5;
    now.setMinutes(rounded); now.setSeconds(0); now.setMilliseconds(0);

    const yyyy = now.getFullYear();
    const mm = pad2(now.getMonth()+1);
    const dd = pad2(now.getDate());
    const hh = pad2(now.getHours());
    const mi = pad2(now.getMinutes());
    const cur = `${yyyy}-${mm}-${dd}T${hh}:${mi}`;

    issueDt.value = cur;
    doneDt.value = cur;

    const end = new Date(now.getTime() + 2*60*60*1000);
    const em = pad2(end.getMonth()+1), ed = pad2(end.getDate()), eh = pad2(end.getHours()), eMi = pad2(end.getMinutes());
    maintStart.value = cur;
    maintEnd.value = `${end.getFullYear()}-${em}-${ed}T${eh}:${eMi}`;
  })();
</script>
</body>
</html>
